/******************************************************************************
 * @file   main_window.cpp
 * @brief  Main app window implementation file.
 *
 * @author brice.c.aa
 ******************************************************************************/

// Related Header
#include "main_window.h"

// C++ Standard Library Headers
#include <sys/stat.h>

// Other Library Headers
#include <QMessageBox>      // Qt::Widgets
#include <QSerialPortInfo>  // Qt::SerialPort

// Project Headers
#include "serial_dialog.h"
#include "ui_main_window.h"  // auto-generated by Qt

/* --- TABLE OF CONTENTS ---
 * !Helper Functions
 * !Menu Bar
 * !Main Window
 * !Pumps
 * !Uncategorized
 */

/**
 * @brief Standard constructor.
 *
 * @param parent Owning Qt widget (default: nullptr)
 */
MainWindow::MainWindow(QWidget* parent)
    : QMainWindow(parent), ui_(new Ui::MainWindow),
      ser_water_(new QSerialPort(this)) {
    ui_->setupUi(this);

    // Set UI elements
    // ui_->a_debug_mode->setChecked(debug_mode_);

    // Check if app is running in Windows Subsystem for Linux (WSL2)
    {
        const char* wsl_path = "/run/WSL";

        struct stat buf {};

        if (stat(wsl_path, &buf) == 0 && S_ISDIR(buf.st_mode)) {
            qWarning()
                << "[WARN] You seem to be running this on WSL2. Please ensure "
                   "you have properly forwarded your USB connections.";
        }
    }
}

/**
 * @brief Standard destructor.
 */
MainWindow::~MainWindow() {
    delete ui_;
}

//------------------------------------------------------------------------------
// !Helper Functions
//------------------------------------------------------------------------------

namespace {  // local to this file

}  // namespace

//------------------------------------------------------------------------------
// !Menu Bar
//------------------------------------------------------------------------------

/**
 * @brief Toggles debug prinouts for this object and all its children.
 */
/*
void MainWindow::on_a_debug_mode_toggled(bool checked) {
    debug_mode_ = checked;

    if (debug_mode_) {
        qDebug() << "[DEBUG] Debug mode enabled";
    }
}
*/

/**
 * @brief Event handler for "Pumps" menu bar action "Connect".
 *        Brings up a dialog box of available serial USB devices.
 */
/*
void MainWindow::on_a_pump_connect_triggered() {
    // Check if SerialWater Arduino (COM3) is connected
    bool found = false;
    foreach (const QSerialPortInfo& info, QSerialPortInfo::availablePorts()) {
        if (info.portName() == "COM3") {
            found = true;
            break;
        }
        if (debug_mode_) {
            // Enumerate available serial ports
            qDebug() << "[DEBUG] Found SerialPort with following metadata";
            qDebug() << "  Port: " << info.portName();
            qDebug() << "  Description: " << info.description();
            qDebug() << "  Manufacturer: " << info.manufacturer() << "\n";
            return;
        }
    }

    if (!found) {
        qDebug() << "[ERROR] SerialWater (COM3) not found!";
        return;
    }

    // Set port options
    ser_water_->setPortName("COM3");
    ser_water_->setBaudRate(QSerialPort::Baud115200);
    ser_water_->setDataBits(QSerialPort::Data8);
    ser_water_->setParity(QSerialPort::NoParity);
    ser_water_->setStopBits(QSerialPort::OneStop);
    ser_water_->setFlowControl(QSerialPort::NoFlowControl);

    // Only continue if "open" was successful
    if (!ser_water_->open(QIODevice::ReadWrite)) {
        qDebug() << "[ERROR] Failed to open port: COM3!";
        QMessageBox::critical(this, tr("Error"), ser_water_->errorString());
        return;
    }

    // Ensure data gets processed when it's made available
    connect(ser_water_, &QSerialPort::readyRead, this,
            &MainWindow::UpdatePumpVals);

    // Reflect changes in UI
    ui_->a_pump_connect->setEnabled(false);
    ui_->a_pump_disconnect->setEnabled(true);
    ui_->pb_pump_enable->setEnabled(true);
    ui_->pb_pump_disable->setEnabled(true);
    ui_->pb_pump_drain->setEnabled(true);
}
*/

/**
 * @brief Event handler for "Pumps" menu bar action "Disconnect".
 *        Terminates the connection to the `SerialWater` Arduino, if it exists.
 */
/*
void MainWindow::on_a_pump_disconnect_triggered() {
    // Clear the Serial object
    if (ser_water_->isOpen()) {
        ser_water_->close();
    }

    // Reflect changes in UI
    ui_->a_pump_connect->setEnabled(true);
    ui_->a_pump_disconnect->setEnabled(false);
    ui_->pb_pump_enable->setEnabled(false);
    ui_->pb_pump_disable->setEnabled(false);
    ui_->pb_pump_drain->setEnabled(false);
}
*/

//------------------------------------------------------------------------------
// !Main Window
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// !Pumps
//------------------------------------------------------------------------------

/**
 * @brief Enables operation of fluid system pumps.
 */
/*
void MainWindow::on_pb_pump_enable_clicked() {
    if (!ser_water_->isOpen()) {
        qDebug() << "[WARN] SerialWater not connected!";
        return;
    }

    qDebug() << "[WARN] Pump control not yet implemented!";

    // TODO: implementation (adapt code below)

    // water_en_ = true;
    // water_mode_ = WaterMode::kStandby;
}
*/

/**
 * @brief Disables operation of fluid system pumps.
 *
 * @todo Combine funcitonality with `on_pb_pump_enable_clicked()` and
 * refactor the resulting function. Don't forget to rename it to something
 * that makes more sense, e.g., including the word "toggle". For reference
 * on changing button text to reflect state, see
 * `on_pb_camera_record_clicked()`.
 */
/*
void MainWindow::on_pb_pump_disable_clicked() {
    if (!ser_water_->isOpen()) {
        qDebug() << "[WARN] SerialWater not connected!";
        return;
    }

    qDebug() << "[WARN] Pump control not yet implemented!";

    // TODO: implementation (adapt code below)
    //water_en_ = false;
    //water_mode_ = WaterMode::kStandby;
}
*/

//------------------------------------------------------------------------------
// !Uncategorized
//------------------------------------------------------------------------------
